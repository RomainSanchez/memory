app.register({core:{ws:{apiAuth:function(){var e=$.Deferred();return app.core.session.tokenIsValid(),e.resolve(),e.promise()},call:function(e,n,s,o,r,t){var p=$.Deferred(),a={0:function(){return p.reject(),p.promise()},302:function(e,n){return app.config.debug&&app.core.ui.toast("Appel non géré par l'API","warning"),n.reject(),n.promise()},400:function(e,n){return app.config.debug&&app.core.ui.toast("Echec de la requête ("+e.responseJSON.code+"): "+e.responseJSON.message,"warning"),n.reject(),n.promise()},401:function(e,n){return app.config.debug&&app.core.ui.toast("Accès refusé ("+e.responseJSON.code+"): "+e.responseJSON.message,"warning"),"Invalid API authentication"===e.responseJSON.message?(app.core.session.tokenExpirationDate=null,app.core.session.save(),app.core.ws.apiAuth().always(function(){n.resolve()}),n.promise()):(n.reject(),n.promise())},404:function(e,s){return app.config.debug&&app.core.ui.toast("Page non trouvée pour l'URL : "+baseUrl+n,"warning"),s.reject(),s.promise()},500:function(e,n){return app.config.debug&&app.core.ui.toast("Le serveur à rencontré une erreur","warning"),n.reject(),n.promise()}};return app.core.ws.apiAuth().then(function(){isDefined(o)||(o=function(e,n,s){}),isDefined(r)||(r=function(e,n,s){}),isDefined(e)||(e="GET"),isDefined(s)||(s={});var i=app.config.webservice.protocol+"://"+app.config.webservice.hostname+(t?"":app.config.webservice.apiBaseUri);"POST"===e&&(s=JSON.stringify(s)),$.ajax({url:i+n,method:e,data:s,crossDomain:!0,success:function(e,n,s){204===s.status&&(e="{}");var r=s.getResponseHeader("content-type");"object"!=typeof e&&"application/json"===r&&(e=JSON.parse(e)),o(e,n,s),p.resolve()},beforeSend:function(n){app.core.session.hasOwnProperty("access_token")&&null!==app.core.session.access_token&&n.setRequestHeader("Authorization",app.core.utils.ucfirst(app.core.session.token_type)+" "+app.core.session.access_token),"POST"===e&&n.setRequestHeader("Content-Type","application/json; charset=utf-8")},error:function(e,n,s){r(e,n,s),a[e.status](e,p)}})},function(){app.core.history.currentState&&app.core.history.currentState.path!==app.ctrl.states.login.path&&app.ctrl.loginAction()}),p.promise()}},session:{tokenIsValid:function(){if(!app.core.session.tokenIsSet())return!1;var e=app.core.utils.parseDate(app.core.session.tokenExpirationDate);return!isDefined(e)||e>app.core.utils.parseDate()},tokenIsSet:function(){return null!==app.core.session.access_token},updateTokenExpirationDate:function(){var e=app.core.utils.parseDate();e.setSeconds(e.getSeconds()+parseInt(app.core.session.expires_in,10)-60),app.core.session.tokenExpirationDate=e,app.core.session.save()}}}});