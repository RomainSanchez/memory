app.register({user:{initEvents:function(){$(document).on("app.ready",function(){app.core.session.user?($("#app").addClass("loggedIn"),app.user.ui.updateProfileName(),app.ctrl.showEvents()):(app.ctrl.loginAction(),$("#app").removeClass("loggedIn"))}).on("submit","#loginForm",function(e){e.stopImmediatePropagation(),e.stopPropagation(),e.preventDefault();var s=$(this),o=app.core.utils.formToObject(s);""!==o.username&&""!==o.password?app.ws.userLogin(o.username,o.password,o.rememberMe,s):(""===o.username&&s.find('input[name="username"]').addClass("invalid"),""===o.password&&s.find('input[name="password"]').addClass("invalid"))}).on("user.logged.in",function(){$("#app").addClass("loggedIn"),app.cart.init()}).on("user.logged.out",function(){$("#app").removeClass("loggedIn")})},ui:{updateProfileName:function(){null!==app.core.session.user.shortName&&""!==app.core.session.user.shortName||(app.core.session.user.shortName=app.core.session.user.firstName.charAt(0)+". "+app.core.session.user.lastName),$('nav a[data-activates="userMenu"] span.button-label').html(app.core.session.user.shortName)}}},ws:{userLogin:function(e,s,o,r){return app.core.ws.call("POST","/login",{email:e,password:s},function(e){var s=e.success.customer;app.core.session.user=s,"on"==o?app.core.session.enableRememberMe():app.core.session.disableRememberMe(),app.core.session.save(),$(document).trigger("user.logged.in"),app.core.history.disableBack=!1,app.ctrl.showEvents()},function(e){r.find("input").addClass("invalid"),app.core.ui.toast("Email et/ou mot de passe invalide","error")})},userLogout:function(){return app.core.ws.call("POST","/logout",{}).always(function(){app.core.session.rememberMe=!1,app.core.session.user=null,app.core.session.save(),app.core.history.disableBack=!0})},getUser:function(e){var s=$.Deferred();return app.core.ws.call("GET","/customers/"+e,{},function(e){void 0!==e.id?(app.core.session.user=e,app.core.session.userId=e.id,app.core.session.save(),s.resolve(e)):(s.reject(e),app.ctrl.logout())}),s.promise()},updateUser:function(e){var s=$.extend(app.core.session.user,app.core.utils.formToObject(e));return s.hasOwnProperty("password_1")&&(s.password=s.password_1,delete s.password_1,delete s.password_2),app.core.ws.call("POST","/customers/"+app.core.session.user.id,s).then(function(){app.ctrl.showUserProfile(),s.hasOwnProperty("password")?app.core.ui.toast("Votre mot de passe à été mis à jour","success"):app.core.ui.toast("Les informations du profil ont bien été mises à jour","success"),$(document).trigger("user.logged.in")})}},ctrl:{states:{login:{path:"/login",title:"Connexion"},showUserProfile:{path:"/profile",title:"Profil"},editUserProfile:{path:"/profile/edit",title:"Modifier mon profil"},editUserPassword:{path:"/password/edit",title:"Modifier mon mot de passe"}},login:function(){app.core.history.currentCallable=app.ctrl.login,app.core.ctrl.go("login",{}).then(function(){app.core.history.add(app.ctrl.states.login)})},logout:function(){app.core.history.currentCallable=app.ctrl.logout,$("#app").removeClass("loggedIn"),app.ws.userLogout().always(function(){$(document).trigger("user.logged.out"),app.ctrl.loginAction()})},showUserProfile:function(){app.core.session.user?(app.core.history.currentCallable=app.ctrl.showUserProfile,app.ws.getUser(app.core.session.user.id).then(function(){app.core.ctrl.go("userProfile",{user:app.core.session.user}).then(function(){app.core.history.add(app.ctrl.states.showUserProfile)})})):app.ctrl.loginAction()},editUserProfile:function(){app.core.session.user?(app.core.history.currentCallable=app.ctrl.editUserProfile,app.ws.getUser(app.core.session.user.id).then(function(){app.core.ctrl.go("editUserProfile",{user:app.core.session.user}).then(function(){app.core.history.add(app.ctrl.states.editUserProfile);try{Materialize.updateTextFields()}catch(e){}})})):app.ctrl.loginAction()},editUserPassword:function(){app.core.session.user?(app.core.history.currentCallable=app.ctrl.editUserPassword,app.ws.getUser(app.core.session.user.id).then(function(){app.core.ctrl.go("editUserPassword",{user:app.core.session.user}).then(function(){try{Materialize.updateTextFields()}catch(e){}app.core.history.add(app.ctrl.states.editUserPassword)})})):app.ctrl.loginAction()},updatePassword:function(e){if(app.core.session.user){var s=app.core.utils.formToObject(e);s.password_1==s.password_2?app.ws.updateUser(e):e.find('input[type="password"]').addClass("invalid")}else app.ctrl.loginAction()},settingsAction:function(){app.core.session.user?(app.core.history.currentCallable=app.ctrl.settingsAction,app.ws.getUser(app.core.session.user.id).then(function(){app.core.ctrl.go("settings").then(function(){try{Materialize.updateTextFields()}catch(e){}app.core.history.add(app.ctrl.states.settings)})})):app.ctrl.loginAction()},updateSettings:function(e){if(app.core.session.user){!0===app.core.utils.formToObject(e).clearAllInfosMessages&&app.featureDiscovery.__resetInfosStorage(),app.ctrl.showEvents(),app.core.ui.toast("Paramètres enregistrés","success")}else app.ctrl.loginAction()}}});